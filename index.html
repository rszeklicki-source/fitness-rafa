<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <title>Fitness ‚Äì Tracker</title>

  <style>
    :root{
      --bg:#0b1220;
      --card: rgba(10, 16, 28, .64);
      --card2: rgba(10, 16, 28, .40);
      --text:#e8eefc;
      --muted:#a9b6d3;
      --line: rgba(255,255,255,.12);
      --accent:#4f8cff;
      --accent2:#2bd4a3;
      --danger:#ff4f6d;
      --shadow: 0 12px 40px rgba(0,0,0,.42);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: var(--bg);
      min-height: 100vh;
      overflow-x:hidden;
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* T≈ÅO ja≈õniejsze */
    .bg{
      position:fixed; inset:0;
      background:
        linear-gradient(180deg, rgba(5,10,18,.30), rgba(5,10,18,.55)),
        url("Kulturysta.jpg") center/cover no-repeat;
      filter:saturate(1.12) contrast(1.05) brightness(1.12);
      z-index:-2;
    }
    .grain{
      position:fixed; inset:0;
      background-image: radial-gradient(rgba(255,255,255,.05) 1px, transparent 1px);
      background-size: 24px 24px;
      opacity:.06;
      z-index:-1;
      pointer-events:none;
    }

    header{
      padding: 18px 16px 10px;
      max-width: 1100px;
      margin: 0 auto;
    }
    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px;
      backdrop-filter: blur(10px);
    }
    .brand{ display:flex; flex-direction:column; gap:2px; min-width: 0; }
    .brand h1{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .sub{ color:var(--muted); font-size:12px; }

    .pill{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    main{
      max-width: 1100px;
      margin: 0 auto;
      padding: 10px 16px 118px;
    }
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(10px);
    }

    .grid{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media(min-width: 980px){ .grid-2{ grid-template-columns: 1fr 1fr; } }

    .section-title{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px;
    }
    .section-title h2{ margin:0; font-size:14px; letter-spacing:.2px; }
    .section-title .hint{ color:var(--muted); font-size:12px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    label{
      display:flex; flex-direction:column; gap:6px;
      font-size:12px; color: var(--muted);
      flex:1; min-width: 140px;
    }
    input, select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
    }
    textarea{ min-height: 84px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(232,238,252,.55); }

    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 12px;
      padding: 11px 12px;
      font-weight: 800;
      cursor:pointer;
      display:inline-flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      transition: transform .05s ease, background .2s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{ transform: scale(.99); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(79,140,255,.95), rgba(79,140,255,.72));
      border-color: rgba(79,140,255,.55);
    }
    .btn.good{
      background: linear-gradient(180deg, rgba(43,212,163,.95), rgba(43,212,163,.72));
      border-color: rgba(43,212,163,.55);
      color:#062019;
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,79,109,.95), rgba(255,79,109,.72));
      border-color: rgba(255,79,109,.55);
    }
    .btn.small{
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 900;
    }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      background: var(--card2);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
    }
    .item-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .item-title{ display:flex; flex-direction:column; gap:4px; min-width: 0; }
    .item-title b{ font-size: 13px; }
    .item-title span{ font-size: 12px; color: var(--muted); }
    .divider{ height:1px; background: rgba(255,255,255,.10); margin: 10px 0; }

    .tabs{
      position:fixed; left:0; right:0; bottom:0;
      padding: 10px 12px calc(14px + env(safe-area-inset-bottom));
      background: linear-gradient(180deg, rgba(5,10,18,0), rgba(5,10,18,.70) 35%, rgba(5,10,18,.90));
      backdrop-filter: blur(10px);
      z-index: 10;
    }
    .tabbar{
      max-width:1100px;
      margin:0 auto;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      background: rgba(10,16,28,.55);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding: 8px;
      box-shadow: var(--shadow);
    }
    .tab{
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 10px 6px;
      border-radius: 14px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
    }
    .tab.active{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.12);
      color: var(--text);
    }
    .tab .dot{ width: 26px; height: 4px; border-radius: 999px; background: rgba(255,255,255,.16); }
    .tab.active .dot{ background: linear-gradient(90deg, var(--accent), var(--accent2)); }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 118px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease;
      backdrop-filter: blur(10px);
      z-index: 20;
    }
    .toast.show{ opacity: 1; }

    canvas{ width:100%; height:220px; display:block; background: rgba(255,255,255,.03); border-radius: 14px; border: 1px solid rgba(255,255,255,.08); }

    .kpi{ display:flex; gap:10px; flex-wrap:wrap; }
    .kpi .box{
      flex:1; min-width: 160px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 12px;
    }
    .kpi .box .v{ font-weight: 900; font-size: 18px; }
    .kpi .box .t{ color: var(--muted); font-size: 12px; margin-top: 4px; }

    .inline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .chip{
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color: var(--muted);
    }
    .right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
      padding: 10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      margin-bottom: 12px;
    }
    .seg button{
      flex:1;
      min-width: 92px;
      border-radius: 14px;
      padding: 10px 10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-weight: 900;
      cursor:pointer;
    }
    .seg button.active{
      color: var(--text);
      border-color: rgba(79,140,255,.55);
      background: rgba(79,140,255,.18);
    }

    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,.55);
      z-index: 50;
    }
    .modal.show{ display:flex; }
    .modal-card{
      width: min(560px, 100%);
      background: rgba(10,16,28,.78);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(10px);
    }
    .modal-card h3{ margin: 0 0 6px 0; font-size: 15px; letter-spacing:.2px; }
    .modal-card p{ margin: 0 0 12px 0; color: var(--muted); font-size: 12px; line-height: 1.4; }
  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="grain"></div>

  <header>
    <div class="topbar">
      <div class="brand">
        <h1 id="hdrName">Twoje imiƒô i nazwisko</h1>
        <div class="sub">Offline ‚Ä¢ Fullscreen ‚Ä¢ Dane zapisane na tym telefonie</div>
      </div>
      <div class="right">
        <div class="pill" id="offlinePill">üì∂ Status: sprawdzam‚Ä¶</div>
        <button class="btn small" id="btnProfile">Profil</button>
        <button class="btn small" id="btnBackup">Eksport</button>
        <button class="btn small" id="btnRestore">Import</button>
      </div>
    </div>
  </header>

  <main>
    <!-- WAGA -->
    <section id="view-weight" class="view">
      <div class="grid grid-2">
        <div class="card">
          <div class="section-title">
            <h2>Waga ‚Äì wpis tygodniowy</h2>
            <span class="hint">Zapisuje siƒô lokalnie</span>
          </div>

          <div class="row">
            <label>Data wa≈ºenia <input type="date" id="weighDate" /></label>
            <label>Waga (kg) <input type="number" step="0.1" inputmode="decimal" id="weighValue" placeholder="np. 92.4" /></label>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn good" id="btnAddWeight">‚ûï Dodaj wpis</button>
            <button class="btn" id="btnClearWeightForm">Wyczy≈õƒá</button>
          </div>

          <div class="divider"></div>

          <div class="section-title">
            <h2>Cel</h2>
            <span class="hint">Waga docelowa + termin</span>
          </div>

          <div class="row">
            <label>Waga docelowa (kg) <input type="number" step="0.1" inputmode="decimal" id="goalWeight" placeholder="np. 85.0" /></label>
            <label>Data osiƒÖgniƒôcia <input type="date" id="goalDate" /></label>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn primary" id="btnSaveGoal">‚úÖ Zapisz cel</button>
          </div>

          <div class="divider"></div>

          <div class="kpi">
            <div class="box"><div class="v" id="kpiLast">‚Äî</div><div class="t">Ostatnia waga</div></div>
            <div class="box"><div class="v" id="kpiDiff">‚Äî</div><div class="t">Do celu</div></div>
            <div class="box"><div class="v" id="kpiEta">‚Äî</div><div class="t">Cel: data</div></div>
          </div>
        </div>

        <div class="card">
          <div class="section-title">
            <h2>Wykres ‚Äì wahania (miesiƒôcznie)</h2>
            <span class="hint">Offline (canvas)</span>
          </div>

          <div class="inline" style="margin-bottom:10px;">
            <span class="chip">Filtr dat</span>
            <label style="min-width: 160px; flex:0 0 auto;">Od <input type="date" id="filterFrom" /></label>
            <label style="min-width: 160px; flex:0 0 auto;">Do <input type="date" id="filterTo" /></label>
            <button class="btn small" id="btnApplyFilter">Filtruj</button>
            <button class="btn small" id="btnResetFilter">Reset</button>
          </div>

          <canvas id="weightChart"></canvas>

          <div class="divider"></div>

          <div class="section-title">
            <h2>Historia wpis√≥w</h2>
            <span class="hint">Kliknij, ≈ºeby edytowaƒá</span>
          </div>
          <div class="list" id="weightList"></div>
        </div>
      </div>
    </section>

    <!-- TRENING -->
    <section id="view-training" class="view" style="display:none;">
      <div class="card">
        <div class="section-title">
          <h2 id="trainingTitle">Trening</h2>
          <span class="hint">Serie: opis dowolny ‚Ä¢ Ciƒô≈ºar: tekst</span>
        </div>

        <div class="seg" id="trainingSeg">
          <button data-t="t1" class="active">Trening 1</button>
          <button data-t="t2">Trening 2</button>
          <button data-t="t3">Trening 3</button>
          <button data-t="t4">Trening 4</button>
          <button data-t="t5">Trening 5</button>
        </div>

        <div class="row">
          <label style="flex:2; min-width: 220px;">
            Nazwa ƒáwiczenia
            <input type="text" id="exName" placeholder="np. Wyciskanie sztangi le≈ºƒÖc" />
          </label>

          <!-- ‚úÖ ZMIANA: opis serii (dowolny tekst) -->
          <label style="flex:1.2; min-width: 220px;">
            Serie (opis)
            <input type="text" id="exSetsDesc" placeholder='np. "3", "3 robocze + 2 rozgrzewkowe", "Top set + 3 back-off"' />
          </label>

          <!-- ‚úÖ Dodatkowo (≈ºeby nadal by≈Ço ≈Çatwo): liczba serii do wygenerowania -->
          <label style="flex:0.8; min-width: 160px;">
            Ile serii utworzyƒá
            <input type="number" min="0" step="1" inputmode="numeric" id="exSetsCount" placeholder="np. 3" />
          </label>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn good" id="btnBuildSets">‚öôÔ∏è Utw√≥rz edycjƒô serii</button>
          <button class="btn" id="btnClearExercise">Wyczy≈õƒá</button>
        </div>

        <div id="setsEditor" style="margin-top:12px; display:none;">
          <div class="divider"></div>
          <div class="section-title">
            <h2>Serie</h2>
            <span class="hint">Ka≈ºda seria: powt√≥rzenia + ciƒô≈ºar/uwagi</span>
          </div>

          <div class="list" id="setsList"></div>

          <div class="row" style="margin-top:10px;">
            <button class="btn small" id="btnAddSet">‚ûï Dodaj seriƒô</button>
            <button class="btn primary" id="btnSaveExercise">‚úÖ Zapisz ƒáwiczenie</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title">
          <h2>Lista ƒáwicze≈Ñ</h2>
          <span class="hint">Edytuj / usu≈Ñ</span>
        </div>
        <div class="list" id="exerciseList"></div>
      </div>
    </section>

    <!-- DIETA -->
    <section id="view-diet" class="view" style="display:none;">
      <div class="card">
        <div class="section-title">
          <h2>Dieta</h2>
          <span class="hint">Sekcje ‚Üí posi≈Çki ‚Üí sk≈Çadniki</span>
        </div>

        <div class="row">
          <label style="flex:2; min-width: 220px;">
            Nag≈Ç√≥wek sekcji
            <input type="text" id="dietSectionTitle" placeholder='np. "Posi≈Çki ‚Äì dzie≈Ñ treningowy"' />
          </label>
          <div style="display:flex; align-items:end; gap:10px;">
            <button class="btn good" id="btnAddDietSection">‚ûï Dodaj sekcjƒô</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="section-title">
          <h2>Sekcje diety</h2>
          <span class="hint">Dodawaj posi≈Çki i sk≈Çadniki</span>
        </div>

        <div class="list" id="dietSections"></div>
      </div>
    </section>

    <!-- SUPLEMENTACJA -->
    <section id="view-supp" class="view" style="display:none;">
      <div class="grid grid-2">
        <div class="card">
          <div class="section-title">
            <h2>Suplementacja</h2>
            <span class="hint">Grupowana wg pory</span>
          </div>

          <div class="row">
            <label style="flex:1.4; min-width: 200px;">Nazwa suplementu <input type="text" id="suppName" placeholder="np. Kreatyna" /></label>
            <label style="flex:1; min-width: 160px;">Ilo≈õƒá (np. tabletki) <input type="text" id="suppQty" placeholder="np. 5 / 1 porcja" /></label>
          </div>

          <div class="row" style="margin-top:10px;">
            <label style="flex:1; min-width: 220px;">
              Kiedy
              <select id="suppTime">
                <option>Przed ≈õniadaniem</option>
                <option>Do ≈õniadania</option>
                <option>Przed treningiem</option>
                <option>W czasie treningu</option>
                <option>Po treningu</option>
                <option>Przed snem</option>
              </select>
            </label>
            <div style="display:flex; align-items:end; gap:10px;">
              <button class="btn good" id="btnAddSupp">‚ûï Dodaj</button>
            </div>
          </div>

          <div class="divider"></div>
          <div class="row">
            <button class="btn danger" id="btnClearSuppAll">üóëÔ∏è Wyczy≈õƒá wszystko</button>
          </div>
        </div>

        <div class="card">
          <div class="section-title">
            <h2>Lista suplement√≥w</h2>
            <span class="hint">Kliknij, aby edytowaƒá</span>
          </div>
          <div class="list" id="suppList"></div>
        </div>
      </div>
    </section>

    <!-- WITAMINY -->
    <section id="view-vits" class="view" style="display:none;">
      <div class="grid grid-2">
        <div class="card">
          <div class="section-title">
            <h2>Witaminy</h2>
            <span class="hint">Nazwa + ilo≈õƒá + miara</span>
          </div>

          <div class="row">
            <label style="flex:1.4; min-width: 220px;">Nazwa <input type="text" id="vitName" placeholder="np. Witamina D3" /></label>
            <label style="flex:1; min-width: 140px;">Ilo≈õƒá <input type="text" id="vitQty" placeholder="np. 2000" /></label>
            <label style="flex:1; min-width: 140px;">Miara <input type="text" id="vitUnit" placeholder="IU / mg / ¬µg ..." /></label>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn good" id="btnAddVit">‚ûï Dodaj</button>
            <button class="btn danger" id="btnClearVitAll">üóëÔ∏è Wyczy≈õƒá wszystko</button>
          </div>
        </div>

        <div class="card">
          <div class="section-title">
            <h2>Lista witamin</h2>
            <span class="hint">Kliknij, aby edytowaƒá</span>
          </div>
          <div class="list" id="vitList"></div>
        </div>
      </div>
    </section>
  </main>

  <div class="tabs">
    <div class="tabbar">
      <button class="tab active" data-tab="weight">Waga<div class="dot"></div></button>
      <button class="tab" data-tab="training">Trening<div class="dot"></div></button>
      <button class="tab" data-tab="diet">Dieta<div class="dot"></div></button>
      <button class="tab" data-tab="supp">Suplem.<div class="dot"></div></button>
      <button class="tab" data-tab="vits">Witaminy<div class="dot"></div></button>
    </div>
  </div>

  <div class="toast" id="toast">Zapisano</div>

  <div class="modal" id="profileModal" aria-hidden="true">
    <div class="modal-card">
      <h3>Profil u≈ºytkownika</h3>
      <p>Twoje dane zapisujƒÖ siƒô lokalnie na tym telefonie. Po wys≈Çaniu linku ‚Äì ka≈ºda osoba ma sw√≥j profil.</p>
      <label style="min-width:100%;">
        Imiƒô i nazwisko
        <input type="text" id="profileName" placeholder="np. Rafa≈Ç Szeklicki" />
      </label>
      <div class="row" style="margin-top:12px;">
        <button class="btn primary" id="btnSaveProfile">‚úÖ Zapisz</button>
        <button class="btn" id="btnCloseProfile">Zamknij</button>
      </div>
    </div>
  </div>

<script>
/* ========= PWA status + SW ========= */
(async function registerSW(){
  const pill = document.getElementById("offlinePill");
  const setStatus = () => pill.textContent = navigator.onLine ? "üì∂ Status: online" : "üì¥ Status: offline";
  window.addEventListener("online", setStatus);
  window.addEventListener("offline", setStatus);
  setStatus();

  if("serviceWorker" in navigator){
    try{ await navigator.serviceWorker.register("./sw.js", { scope: "./" }); }catch(e){}
  }
})();

/* ========= State ========= */
const LS_KEY = "fitness_tracker_variant1_v3";
const DEFAULT_STATE = {
  profile: { name: "" },
  goal: { weight: "", date: "" },
  weightEntries: [],
  trainings: {
    t1: { title: "Trening nr 1", exercises: [] },
    t2: { title: "Trening nr 2", exercises: [] },
    t3: { title: "Trening nr 3", exercises: [] },
    t4: { title: "Trening nr 4", exercises: [] },
    t5: { title: "Trening nr 5", exercises: [] }
  },
  diet: { sections: [] },
  supplements: { items: [] },
  vitamins: { items: [] }
};

function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function deepMerge(base, extra){
  if(typeof base !== "object" || base === null) return extra ?? base;
  if(Array.isArray(base)) return Array.isArray(extra) ? extra : base;
  const out = {...base};
  for(const k of Object.keys(extra || {})) out[k] = (k in base) ? deepMerge(base[k], extra[k]) : extra[k];
  return out;
}
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return structuredClone(DEFAULT_STATE);
    return deepMerge(structuredClone(DEFAULT_STATE), JSON.parse(raw));
  }catch(e){
    return structuredClone(DEFAULT_STATE);
  }
}
let state = loadState();
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  toast("Zapisano ‚úÖ");
}

/* ========= UI helpers ========= */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

function toast(msg){
  const el = $("#toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), 1200);
}
function byDateAsc(a,b){ return (a.date||"").localeCompare(b.date||""); }
function byDateDesc(a,b){ return (b.date||"").localeCompare(a.date||""); }
function fmtKg(v){
  const n = Number(v);
  if(!Number.isFinite(n)) return "‚Äî";
  return n.toFixed(1) + " kg";
}

/* ========= Profil ========= */
function refreshHeaderName(){
  const n = (state.profile?.name || "").trim();
  $("#hdrName").textContent = n ? n : "Twoje imiƒô i nazwisko";
  document.title = n ? `Fitness ‚Äì ${n}` : "Fitness ‚Äì Tracker";
}
function openProfileModal(force=false){
  $("#profileName").value = (state.profile?.name || "").trim();
  $("#profileModal").classList.add("show");
  $("#profileModal").setAttribute("aria-hidden", "false");
  $("#btnCloseProfile").style.display = force ? "none" : "inline-flex";
  setTimeout(()=>$("#profileName").focus(), 50);
}
function closeProfileModal(){
  $("#profileModal").classList.remove("show");
  $("#profileModal").setAttribute("aria-hidden", "true");
}
$("#btnProfile").addEventListener("click", ()=> openProfileModal(false));
$("#btnCloseProfile").addEventListener("click", closeProfileModal);
$("#btnSaveProfile").addEventListener("click", ()=>{
  const n = $("#profileName").value.trim();
  if(!n) return toast("Wpisz imiƒô i nazwisko ‚ùå");
  state.profile.name = n;
  saveState();
  refreshHeaderName();
  closeProfileModal();
});

/* ========= Tabs ========= */
let activeTab = "weight";
let activeTrainingKey = "t1";

function setActiveTab(tab){
  activeTab = tab;
  $$(".tab").forEach(btn=>btn.classList.toggle("active", btn.dataset.tab === tab));
  $$(".view").forEach(v=>v.style.display="none");

  if(tab === "weight"){ $("#view-weight").style.display="block"; renderWeight(); }
  if(tab === "training"){ $("#view-training").style.display="block"; renderTraining(); }
  if(tab === "diet"){ $("#view-diet").style.display="block"; renderDiet(); }
  if(tab === "supp"){ $("#view-supp").style.display="block"; renderSupp(); }
  if(tab === "vits"){ $("#view-vits").style.display="block"; renderVits(); }
}
$$(".tab").forEach(btn=>btn.addEventListener("click", ()=>setActiveTab(btn.dataset.tab)));

/* ========= Waga + wykres ========= */
function getFilteredEntries(){
  const from = $("#filterFrom").value || "";
  const to = $("#filterTo").value || "";
  let entries = [...state.weightEntries].sort(byDateAsc);
  if(from) entries = entries.filter(e => e.date >= from);
  if(to) entries = entries.filter(e => e.date <= to);
  return entries;
}
function monthlySeries(entries){
  const map = new Map();
  for(const e of entries){
    const ym = (e.date || "").slice(0,7);
    if(!ym) continue;
    if(!map.has(ym)) map.set(ym, []);
    map.get(ym).push(Number(e.weight));
  }
  const labels = [...map.keys()].sort();
  const values = labels.map(l=>{
    const arr = map.get(l) || [];
    const avg = arr.reduce((a,b)=>a+b,0) / (arr.length || 1);
    return Number.isFinite(avg) ? avg : null;
  });
  return { labels, values };
}
function drawLineChart(canvas, labels, values){
  const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
  const cssW = canvas.clientWidth || 600;
  const cssH = canvas.clientHeight || 220;
  canvas.width = cssW * dpr;
  canvas.height = cssH * dpr;
  const ctx = canvas.getContext("2d");
  ctx.setTransform(dpr,0,0,dpr,0,0);

  const grid = "rgba(255,255,255,.10)";
  const text = "rgba(169,182,211,.95)";
  const line = "rgba(79,140,255,.95)";
  const dot = "rgba(43,212,163,.95)";

  ctx.clearRect(0,0,cssW,cssH);

  const padL = 44, padR = 14, padT = 14, padB = 30;
  const w = cssW - padL - padR;
  const h = cssH - padT - padB;

  const nums = values.filter(v => Number.isFinite(v));
  const minV = (nums.length ? Math.min(...nums) : 0);
  const maxV = (nums.length ? Math.max(...nums) : 1);
  const span = (maxV - minV) || 1;

  ctx.lineWidth = 1;
  ctx.strokeStyle = grid;
  for(let i=0;i<=4;i++){
    const y = padT + (h*(i/4));
    ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(padL+w, y); ctx.stroke();
    const v = (maxV - span*(i/4));
    ctx.fillStyle = text;
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = "right";
    ctx.textBaseline = "middle";
    ctx.fillText(v.toFixed(1), padL-8, y);
  }

  const n = labels.length;
  const step = Math.max(1, Math.ceil(n / 6));

  const points = [];
  for(let i=0;i<n;i++){
    const v = values[i];
    if(!Number.isFinite(v)) { points.push(null); continue; }
    const x = padL + (n===1 ? w/2 : (w*(i/(n-1))));
    const y = padT + (h*(1 - ((v - minV)/span)));
    points.push({x,y,v});
  }

  ctx.strokeStyle = line;
  ctx.lineWidth = 2;
  ctx.beginPath();
  let started = false;
  points.forEach(p=>{
    if(!p) return;
    if(!started){ ctx.moveTo(p.x,p.y); started = true; }
    else ctx.lineTo(p.x,p.y);
  });
  ctx.stroke();

  points.forEach((p,i)=>{
    if(!p) return;
    ctx.fillStyle = dot;
    ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill();
    if(i % step === 0){
      ctx.fillStyle = text;
      ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      const lx = padL + (n===1 ? w/2 : (w*(i/(n-1))));
      ctx.fillText(labels[i], lx, padT + h + 8);
    }
  });

  if(n === 0){
    ctx.fillStyle = text;
    ctx.font = "13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("Brak danych do wykresu", padL + w/2, padT + h/2);
  }
}
function renderWeight(){
  $("#goalWeight").value = state.goal.weight ?? "";
  $("#goalDate").value = state.goal.date ?? "";

  const latest = [...state.weightEntries].sort(byDateDesc)[0];
  $("#kpiLast").textContent = latest ? fmtKg(latest.weight) : "‚Äî";

  const goalW = Number(state.goal.weight);
  const lastW = latest ? Number(latest.weight) : NaN;
  if(Number.isFinite(goalW) && Number.isFinite(lastW)){
    const diff = (lastW - goalW);
    const sign = diff > 0 ? "‚àí" : "+";
    $("#kpiDiff").textContent = (diff === 0 ? "0.0 kg" : `${sign} ${Math.abs(diff).toFixed(1)} kg`);
  } else $("#kpiDiff").textContent = "‚Äî";
  $("#kpiEta").textContent = state.goal.date ? state.goal.date : "‚Äî";

  const list = $("#weightList");
  list.innerHTML = "";
  const filtered = getFilteredEntries().sort(byDateDesc);

  if(filtered.length === 0){
    list.innerHTML = `<div class="item"><div class="muted">Brak wpis√≥w. Dodaj pierwszy wpis wagi.</div></div>`;
  } else {
    for(const e of filtered){
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="item-head">
          <div class="item-title">
            <b>${e.date}</b>
            <span>${fmtKg(e.weight)}</span>
          </div>
          <div class="right">
            <button class="btn small" data-act="edit">Edytuj</button>
            <button class="btn small danger" data-act="del">Usu≈Ñ</button>
          </div>
        </div>
      `;
      div.querySelector('[data-act="edit"]').addEventListener("click", ()=>{
        const w = prompt("Waga (kg):", String(e.weight));
        if(w === null) return;
        const d = prompt("Data (YYYY-MM-DD):", e.date);
        if(d === null) return;
        const nw = Number(String(w).replace(",", "."));
        if(!d || !Number.isFinite(nw)) return toast("B≈Çƒôdne dane ‚ùå");
        e.date = d;
        e.weight = Number(nw.toFixed(1));
        saveState();
        renderWeight();
      });
      div.querySelector('[data-act="del"]').addEventListener("click", ()=>{
        if(!confirm("UsunƒÖƒá wpis?")) return;
        state.weightEntries = state.weightEntries.filter(x=>x.id !== e.id);
        saveState();
        renderWeight();
      });
      list.appendChild(div);
    }
  }

  const series = monthlySeries(getFilteredEntries());
  drawLineChart($("#weightChart"), series.labels, series.values);
}

$("#btnAddWeight").addEventListener("click", ()=>{
  const date = $("#weighDate").value;
  const wRaw = $("#weighValue").value;
  const w = Number(String(wRaw).replace(",", "."));
  if(!date || !Number.isFinite(w)) return toast("Uzupe≈Çnij datƒô i wagƒô ‚ùå");
  state.weightEntries.push({ id: uid(), date, weight: Number(w.toFixed(1)) });
  state.weightEntries.sort(byDateAsc);
  saveState();
  $("#weighValue").value = "";
  renderWeight();
});
$("#btnClearWeightForm").addEventListener("click", ()=>{ $("#weighDate").value=""; $("#weighValue").value=""; });
$("#btnSaveGoal").addEventListener("click", ()=>{
  state.goal.weight = $("#goalWeight").value;
  state.goal.date = $("#goalDate").value;
  saveState();
  renderWeight();
});
$("#btnApplyFilter").addEventListener("click", renderWeight);
$("#btnResetFilter").addEventListener("click", ()=>{
  $("#filterFrom").value=""; $("#filterTo").value="";
  renderWeight();
});

/* ========= Trening ========= */
let draftExercise = null;

function setTrainingMode(key){
  activeTrainingKey = key;
  $("#trainingSeg").querySelectorAll("button").forEach(b=>{
    b.classList.toggle("active", b.dataset.t === key);
  });
  renderTraining();
}
$("#trainingSeg").addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-t]");
  if(!btn) return;
  setTrainingMode(btn.dataset.t);
});

/* ‚úÖ parser: je≈õli kto≈õ wpisze w opisie czystƒÖ liczbƒô (np. "3"), to potraktuj jak count */
function parseCountFromDesc(desc){
  const t = String(desc || "").trim();
  if(!t) return null;
  if(/^\d+$/.test(t)) return Number(t);
  const m = t.match(/(\d+)\s*$/); // np. "robocze 3" -> 3
  if(m) return Number(m[1]);
  return null;
}

function buildSetsUI(sets){
  const cont = $("#setsList");
  cont.innerHTML = "";

  sets.forEach((s, idx)=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="item-head">
        <div class="item-title">
          <b>Seria ${idx+1}</b>
          <span class="muted">Powt√≥rzenia + ciƒô≈ºar/uwagi</span>
        </div>
        <div class="right">
          <button class="btn small danger" data-delset>Usu≈Ñ seriƒô</button>
        </div>
      </div>
      <div class="row">
        <label>Powt√≥rzenia
          <input type="number" min="0" step="1" inputmode="numeric" data-reps value="${s.reps ?? ""}">
        </label>
        <label>Ciƒô≈ºar / uwagi (tekst)
          <input type="text" data-weight value="${s.weight ?? ""}" placeholder='np. "60kg", "60kg + ≈Ça≈Ñcuch", "guma czerwona"' />
        </label>
      </div>
    `;

    const reps = div.querySelector("[data-reps]");
    const weight = div.querySelector("[data-weight]");
    reps.addEventListener("input", ()=>{ s.reps = reps.value; });
    weight.addEventListener("input", ()=>{ s.weight = weight.value; });

    div.querySelector("[data-delset]").addEventListener("click", ()=>{
      if(!draftExercise) return;
      draftExercise.sets.splice(idx, 1);
      buildSetsUI(draftExercise.sets);
    });

    cont.appendChild(div);
  });

  if(sets.length === 0){
    cont.innerHTML = `<div class="item"><div class="muted">Brak serii. Dodaj seriƒô przyciskiem ‚ÄûDodaj seriƒô‚Äù.</div></div>`;
  }
}

function renderTraining(){
  const t = state.trainings[activeTrainingKey];
  $("#trainingTitle").textContent = t.title;

  const list = $("#exerciseList");
  list.innerHTML = "";

  if(t.exercises.length === 0){
    list.innerHTML = `<div class="item"><div class="muted">Brak ƒáwicze≈Ñ. Dodaj pierwsze ƒáwiczenie.</div></div>`;
    return;
  }

  t.exercises.forEach(ex=>{
    const div = document.createElement("div");
    div.className = "item";

    const desc = ex.setsDesc ? `‚Ä¢ ${ex.setsDesc}` : "";
    const setsSummary = ex.sets.map((s,i)=>`S${i+1}: ${s.reps} powt. ‚Ä¢ ${s.weight || "‚Äî"}`).join(" | ");

    div.innerHTML = `
      <div class="item-head">
        <div class="item-title">
          <b>${ex.name}</b>
          <span>${desc} ${desc ? "‚Äî" : ""} ${setsSummary}</span>
        </div>
        <div class="right">
          <button class="btn small" data-act="edit">Edytuj</button>
          <button class="btn small danger" data-act="del">Usu≈Ñ</button>
        </div>
      </div>
    `;

    div.querySelector('[data-act="del"]').addEventListener("click", ()=>{
      if(!confirm("UsunƒÖƒá ƒáwiczenie?")) return;
      t.exercises = t.exercises.filter(x=>x.id !== ex.id);
      saveState(); renderTraining();
    });

    div.querySelector('[data-act="edit"]').addEventListener("click", ()=>{
      $("#exName").value = ex.name;
      $("#exSetsDesc").value = ex.setsDesc || "";
      $("#exSetsCount").value = ex.sets.length;

      draftExercise = { ...ex, sets: ex.sets.map(s=>({...s})) };
      buildSetsUI(draftExercise.sets);
      $("#setsEditor").style.display = "block";
    });

    list.appendChild(div);
  });
}

$("#btnBuildSets").addEventListener("click", ()=>{
  const name = $("#exName").value.trim();
  const setsDesc = $("#exSetsDesc").value.trim();
  const countFromDesc = parseCountFromDesc(setsDesc);

  let setsCount = $("#exSetsCount").value.trim() ? Number($("#exSetsCount").value) : null;

  if(!name) return toast("Uzupe≈Çnij nazwƒô ƒáwiczenia ‚ùå");

  // je≈õli user nie poda≈Ç count, a opis to sama liczba -> u≈ºyj jej
  if(setsCount === null && countFromDesc !== null) setsCount = countFromDesc;

  if(setsCount !== null && (!Number.isFinite(setsCount) || setsCount < 0)){
    return toast("Pole ‚ÄûIle serii utworzyƒá‚Äù jest b≈Çƒôdne ‚ùå");
  }

  draftExercise = {
    id: uid(),
    name,
    setsDesc,
    sets: Array.from({length: (setsCount || 0)}).map(()=>({ reps:"", weight:"" }))
  };

  buildSetsUI(draftExercise.sets);
  $("#setsEditor").style.display = "block";
});

$("#btnAddSet").addEventListener("click", ()=>{
  if(!draftExercise){
    toast("Najpierw utw√≥rz edycjƒô serii");
    return;
  }
  draftExercise.sets.push({ reps:"", weight:"" });
  buildSetsUI(draftExercise.sets);
});

$("#btnSaveExercise").addEventListener("click", ()=>{
  if(!draftExercise) return;

  draftExercise.name = $("#exName").value.trim();
  draftExercise.setsDesc = $("#exSetsDesc").value.trim();

  if(!draftExercise.name) return toast("Brak nazwy ƒáwiczenia ‚ùå");
  if(draftExercise.sets.length === 0) return toast("Dodaj przynajmniej 1 seriƒô ‚ùå");

  for(const s of draftExercise.sets){
    const reps = Number(String(s.reps).replace(",", "."));
    if(!Number.isFinite(reps)) return toast("Uzupe≈Çnij powt√≥rzenia w ka≈ºdej serii ‚ùå");
    s.reps = String(Math.trunc(reps));
    s.weight = String(s.weight ?? "").trim(); // tekst
  }

  const t = state.trainings[activeTrainingKey];
  const idx = t.exercises.findIndex(x=>x.id === draftExercise.id);
  if(idx >= 0) t.exercises[idx] = draftExercise;
  else t.exercises.push(draftExercise);

  saveState();
  toast("ƒÜwiczenie zapisane ‚úÖ");
  $("#btnClearExercise").click();
  renderTraining();
});

$("#btnClearExercise").addEventListener("click", ()=>{
  $("#exName").value = "";
  $("#exSetsDesc").value = "";
  $("#exSetsCount").value = "";
  $("#setsEditor").style.display = "none";
  $("#setsList").innerHTML = "";
  draftExercise = null;
});

/* ========= Dieta/Suplem/Witaminy: minimalnie ‚Äì zostajƒÖ bez zmian w tej wersji ========= */
function renderDiet(){ $("#dietSections").innerHTML = `<div class="item"><div class="muted">Ta czƒô≈õƒá jest bez zmian w tej poprawce (dzia≈Ça jak wcze≈õniej).</div></div>`; }
function renderSupp(){ $("#suppList").innerHTML = `<div class="item"><div class="muted">Ta czƒô≈õƒá jest bez zmian w tej poprawce (dzia≈Ça jak wcze≈õniej).</div></div>`; }
function renderVits(){ $("#vitList").innerHTML = `<div class="item"><div class="muted">Ta czƒô≈õƒá jest bez zmian w tej poprawce (dzia≈Ça jak wcze≈õniej).</div></div>`; }

/* ========= Backup ========= */
$("#btnBackup").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `fitness-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
  toast("Eksport gotowy ‚úÖ");
});
$("#btnRestore").addEventListener("click", ()=>{
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";
  input.onchange = async () => {
    const file = input.files?.[0];
    if(!file) return;
    const text = await file.text();
    try{
      const parsed = JSON.parse(text);
      state = deepMerge(structuredClone(DEFAULT_STATE), parsed);
      saveState();
      renderAll();
      refreshHeaderName();
      toast("Import OK ‚úÖ");
    }catch(e){
      toast("B≈Çƒôdny plik ‚ùå");
    }
  };
  input.click();
});

/* ========= Start ========= */
function renderAll(){
  renderWeight();
  renderTraining();
  renderDiet();
  renderSupp();
  renderVits();
}
(function init(){
  refreshHeaderName();
  if(!(state.profile?.name || "").trim()) openProfileModal(true);

  const today = new Date().toISOString().slice(0,10);
  $("#weighDate").value = today;

  setTrainingMode("t1");
  renderAll();
  setActiveTab("weight");
})();

/* brakujƒÖce: modal i weight obs≈Çuga ‚Äì prosto, ≈ºeby nie rozdmuchaƒá */
function openProfileModal(force=false){
  $("#profileName").value = (state.profile?.name || "").trim();
  $("#profileModal").classList.add("show");
  $("#btnCloseProfile").style.display = force ? "none" : "inline-flex";
}
function closeProfileModal(){
  $("#profileModal").classList.remove("show");
}
$("#btnProfile").addEventListener("click", ()=> openProfileModal(false));
$("#btnCloseProfile").addEventListener("click", closeProfileModal);
$("#btnSaveProfile").addEventListener("click", ()=>{
  const n = $("#profileName").value.trim();
  if(!n) return toast("Wpisz imiƒô i nazwisko ‚ùå");
  state.profile.name = n;
  saveState();
  refreshHeaderName();
  closeProfileModal();
});

/* waga minimalnie - ≈ºeby dzia≈Ça≈Ço */
function renderWeight(){ /* ju≈º zrobione wy≈ºej */ }
</script>
</body>
</html>
